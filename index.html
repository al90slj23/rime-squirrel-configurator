<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rime å¯è§†åŒ–é…ç½®å™¨ï¼ˆ.custom.yaml ç”Ÿæˆå™¨ï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
<style>
  :root {
    --bg:#0b0c0f;
    --card:#151922;
    --card-hover:#1a1f2c;
    --muted:#8ea0b5;
    --text:#e7ecf3;
    --accent:#5ac8fa;
    --accent-hover:#4ab3e8;
    --border:#273043;
    --input-bg:#0f1320;
  }

  * { box-sizing: border-box; }

  html,body{
    background:var(--bg);
    color:var(--text);
    font:15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Noto Sans CJK SC", sans-serif;
    margin:0;
    padding:0;
    -webkit-font-smoothing: antialiased;
  }

  .wrap{
    max-width:1100px;
    margin:40px auto;
    padding:0 24px;
  }

  .card{
    background:var(--card);
    border-radius:16px;
    padding:28px 32px;
    margin:20px 0;
    box-shadow:0 4px 20px rgba(0,0,0,.3);
    transition: transform .2s ease, box-shadow .2s ease;
  }

  .card:hover{
    box-shadow:0 6px 24px rgba(0,0,0,.4);
  }

  h1{
    font-size:28px;
    font-weight:700;
    margin:0 0 8px;
    display:flex;
    align-items:center;
    flex-wrap:wrap;
    gap:12px;
  }

  h2{
    font-size:14px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:.5px;
    margin:0 0 16px;
    color:var(--muted);
    padding-bottom:8px;
    border-bottom:1px solid var(--border);
  }

  .section{
    margin-bottom:32px;
  }

  .section:last-child{
    margin-bottom:0;
  }

  label{
    display:flex;
    align-items:center;
    gap:10px;
    margin:12px 0;
    cursor:pointer;
    font-size:14px;
  }

  label:hover{
    color:var(--accent);
  }

  .label-text{
    flex:1;
    min-width:0;
  }

  input[type="text"],
  input[type="number"],
  select{
    flex:1;
    min-width:200px;
    max-width:400px;
    background:var(--input-bg);
    border:1px solid var(--border);
    border-radius:10px;
    padding:10px 14px;
    color:var(--text);
    font-size:14px;
    transition: border-color .2s ease, background .2s ease;
  }

  select{
    cursor:pointer;
  }

  select option{
    background:var(--card);
    color:var(--text);
  }

  input[type="number"]{
    min-width:80px;
  }

  input[type="text"]:focus,
  input[type="number"]:focus,
  select:focus{
    outline:none;
    border-color:var(--accent);
    background:#131825;
  }

  .row{
    display:flex;
    flex-wrap:wrap;
    gap:20px;
    align-items:center;
  }

  .switch{
    appearance:none;
    width:48px;
    height:28px;
    background:#2a3346;
    border-radius:20px;
    position:relative;
    outline:none;
    cursor:pointer;
    transition:background .2s ease;
    flex-shrink:0;
  }

  .switch:hover{
    background:#323d54;
  }

  .switch:checked{
    background:var(--accent);
  }

  .switch:checked:hover{
    background:var(--accent-hover);
  }

  .switch::after{
    content:"";
    position:absolute;
    top:3px;
    left:3px;
    width:22px;
    height:22px;
    background:#fff;
    border-radius:50%;
    transition:transform .25s ease;
    box-shadow:0 2px 4px rgba(0,0,0,.2);
  }

  .switch:checked::after{
    transform:translateX(20px);
  }

  .radio-wrap{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }

  input[type="radio"]{
    width:18px;
    height:18px;
    cursor:pointer;
    accent-color:var(--accent);
  }

  .badge{
    display:inline-block;
    padding:4px 10px;
    border-radius:6px;
    background:#223047;
    color:#b5c2d5;
    font-size:11px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:.3px;
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    gap:32px;
  }

  textarea{
    width:100%;
    min-height:280px;
    background:var(--input-bg);
    border:1px solid var(--border);
    border-radius:12px;
    padding:16px;
    color:#bfe2ff;
    font-family:'SF Mono', Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-size:13px;
    line-height:1.6;
    white-space:pre;
    resize:vertical;
    transition: border-color .2s ease;
  }

  textarea:focus{
    outline:none;
    border-color:var(--accent);
  }

  button{
    background:var(--accent);
    color:#001018;
    border:0;
    border-radius:10px;
    padding:12px 24px;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    transition:background .2s ease, transform .1s ease;
    white-space:nowrap;
  }

  button:hover{
    background:var(--accent-hover);
    transform:translateY(-1px);
  }

  button:active{
    transform:translateY(0);
  }

  .muted{
    color:var(--muted);
    font-size:13px;
    line-height:1.5;
  }

  .drop{
    border:2px dashed #3a4761;
    border-radius:12px;
    padding:40px 24px;
    text-align:center;
    color:#9fb2c7;
    cursor:pointer;
    transition:all .2s ease;
    background:rgba(15,19,32,.3);
  }

  .drop:hover{
    border-color:#4a5771;
    background:rgba(15,19,32,.5);
  }

  .drop.drag{
    background:var(--input-bg);
    border-color:var(--accent);
    color:var(--accent);
    border-width:3px;
  }

  code{
    background:var(--input-bg);
    border:1px solid var(--border);
    border-radius:6px;
    padding:2px 8px;
    font-family:'SF Mono', Monaco, Consolas, monospace;
    font-size:12px;
  }

  .hint{
    margin-top:8px;
    padding:12px 16px;
    background:rgba(90,200,250,.08);
    border-left:3px solid var(--accent);
    border-radius:6px;
  }

  @media (max-width: 768px){
    .wrap{
      margin:20px auto;
      padding:0 16px;
    }

    .card{
      padding:20px;
      margin:16px 0;
    }

    h1{
      font-size:24px;
    }

    .grid{
      grid-template-columns:1fr;
      gap:24px;
    }

    input[type="text"],
    input[type="number"],
    select{
      max-width:100%;
    }

    .row{
      flex-direction:column;
      align-items:flex-start;
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Rime å¯è§†åŒ–é…ç½®å™¨ <span class="badge">ç”Ÿæˆ *.custom.yaml</span></h1>

  <div class="card">
    <div class="grid">
      <div class="section">
        <h2>æ–¹æ¡ˆï¼ˆSchemaï¼‰</h2>
        <div style="margin-bottom:8px">
          <div class="label-text" style="margin-bottom:8px">æ–¹æ¡ˆæ ‡è¯†ï¼ˆæ–‡ä»¶å‰ç¼€ï¼‰</div>
          <input id="schemaId" type="text" value="luna_pinyin" placeholder="ä¾‹å¦‚: luna_pinyin" style="width:100%;max-width:100%" />
        </div>
        <div class="muted">ç”Ÿæˆçš„æ–‡ä»¶åï¼š<code id="outName">luna_pinyin.custom.yaml</code></div>
      </div>

      <div class="section">
        <h2>é»˜è®¤å­—å½¢</h2>
        <div class="radio-wrap">
          <label><input type="radio" name="simp" value="simp" checked /> é»˜è®¤ç®€ä½“</label>
          <label><input type="radio" name="simp" value="trad" /> é»˜è®¤ç¹ä½“</label>
        </div>
        <div class="muted" style="margin-top:12px">çƒ­é”®åˆ‡æ¢ï¼š<code>Control+Shift+F</code></div>
      </div>

      <div class="section">
        <h2>è¾“å…¥æ¨¡å¼</h2>
        <label>
          <input class="switch" id="asciiMode" type="checkbox" checked />
          <span class="label-text">é»˜è®¤ã€Œä¸­æ–‡æ¨¡å¼ã€</span>
          <span class="badge">å…³é—­=è¥¿æ–‡</span>
        </label>
        <label>
          <input class="switch" id="fullShape" type="checkbox" />
          <span class="label-text">é»˜è®¤ã€Œå…¨è§’ã€</span>
          <span class="badge">å»ºè®®å…³é—­</span>
        </label>
        <label>
          <input class="switch" id="asciiPunct" type="checkbox" checked />
          <span class="label-text">é»˜è®¤ã€Œä¸­æ–‡æ ‡ç‚¹ã€</span>
        </label>
      </div>

      <div class="section">
        <h2>çƒ­é”®é…ç½®</h2>
        <div style="margin-bottom:8px">
          <div class="label-text" style="margin-bottom:8px">ç®€ç¹åˆ‡æ¢çƒ­é”®</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="hotkey" type="text" value="Control+Shift+F" placeholder="Control+Shift+F" style="flex:1" readonly />
            <button id="recordHotkey" style="padding:10px 16px;white-space:nowrap">ğŸ¹ å½•åˆ¶</button>
          </div>
        </div>
        <div class="muted">ç‚¹å‡»"å½•åˆ¶"æŒ‰é’®åæŒ‰ä¸‹å¿«æ·é”®ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥ã€‚å¤šç»„çƒ­é”®ç”¨é€—å·åˆ†éš”</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 24px">å€™é€‰è¯è®¾ç½®</h2>
    <div class="grid">
      <div class="section">
        <h2>é¡µé¢æ˜¾ç¤º</h2>
        <label>
          <span class="label-text">æ¯é¡µå€™é€‰è¯æ•°é‡</span>
          <input id="pageSize" type="number" min="1" max="10" value="6" style="max-width:100px" />
        </label>
        <div class="muted">å»ºè®®å€¼ï¼š5-9 ä¸ª</div>
      </div>

      <div class="section">
        <h2>å€™é€‰è¯æ ‡ç­¾</h2>
        <div class="radio-wrap">
          <label><input type="radio" name="selectLabels" value="number" checked /> æ•°å­—æ ‡ç­¾ï¼ˆ1 2 3ï¼‰</label>
          <label><input type="radio" name="selectLabels" value="custom" /> è‡ªå®šä¹‰æ ‡ç­¾</label>
        </div>
        <label id="customLabelsWrap" style="margin-top:12px;display:none">
          <span class="label-text">è‡ªå®šä¹‰æ ‡ç­¾</span>
          <input id="customLabels" type="text" placeholder="ä¾‹å¦‚: a s d f g h j k l" />
        </label>
        <div class="muted" style="margin-top:8px">æ•°å­—æ ‡ç­¾æ˜¾ç¤ºä¸º â‘ â‘¡â‘¢... æˆ– 1 2 3...</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 24px">é«˜çº§è®¾ç½®</h2>
    <div class="grid">
      <div class="section">
        <h2>ASCII æ¨¡å¼</h2>
        <label>
          <input class="switch" id="asciiComposer" type="checkbox" checked />
          <span class="label-text">å¯ç”¨ good_old_caps_lock</span>
          <span class="badge">æ¨èå¼€å¯</span>
        </label>
        <div class="muted">Caps Lock ä¼ ç»Ÿè¡Œä¸ºï¼ˆå¤§å†™é”å®šï¼‰</div>
      </div>

      <div class="section">
        <h2>è¯†åˆ«å™¨æ¨¡å¼</h2>
        <label>
          <input class="switch" id="enableEmail" type="checkbox" checked />
          <span class="label-text">é‚®ç®±è¯†åˆ«</span>
        </label>
        <label>
          <input class="switch" id="enableUrl" type="checkbox" checked />
          <span class="label-text">URL è¯†åˆ«</span>
        </label>
        <label>
          <input class="switch" id="enableUppercase" type="checkbox" checked />
          <span class="label-text">å¤§å†™å­—æ¯è¯†åˆ«</span>
        </label>
        <div class="muted">è‡ªåŠ¨è¯†åˆ«å¹¶ç›´æ¥è¾“å‡ºç‰¹æ®Šæ ¼å¼</div>
      </div>
    </div>

    <div class="grid" style="margin-top:24px">
      <div class="section">
        <h2>æ ‡ç‚¹ç¬¦å·</h2>
        <label>
          <input class="switch" id="enablePunctuator" type="checkbox" checked />
          <span class="label-text">å¯ç”¨æ ‡ç‚¹ç¬¦å·å€™é€‰</span>
          <span class="badge">æ¨èå¼€å¯</span>
        </label>
        <div class="muted">è¾“å…¥ [ / ; ç­‰ç¬¦å·æ—¶æ˜¾ç¤ºå€™é€‰æ¡†ï¼ˆå…¨è§’/åŠè§’åˆ‡æ¢ï¼‰</div>
      </div>

      <div class="section">
        <h2>å…¶ä»–å¼€å…³</h2>
        <label>
          <input class="switch" id="enableEmoji" type="checkbox" />
          <span class="label-text">å¯ç”¨ Emoji è¾“å…¥</span>
        </label>
        <label>
          <input class="switch" id="enableLunar" type="checkbox" />
          <span class="label-text">æ˜¾ç¤ºå†œå†æ—¥æœŸ</span>
        </label>
        <label>
          <input class="switch" id="enableSymbols" type="checkbox" checked />
          <span class="label-text">å¯ç”¨ç¬¦å·è¾“å…¥</span>
          <span class="badge">æ¨è</span>
        </label>
        <div class="muted">å¯ç”¨åä¼šè‡ªåŠ¨ç”Ÿæˆç›¸åº”çš„è¯åº“å’Œè„šæœ¬æ–‡ä»¶ã€‚ç¬¦å·è¾“å…¥åŒ…æ‹¬ï¼šâ‰ˆ â‰  â‰¤ â‰¥ â†’ â† ç­‰</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 24px">ğŸ¨ é¼ é¡»ç®¡çš®è‚¤é…ç½® <span class="badge">squirrel.custom.yaml</span></h2>
    <div class="grid">
      <div class="section">
        <h2>é…è‰²æ–¹æ¡ˆ</h2>
        <label>
          <span class="label-text">æµ…è‰²æ¨¡å¼ä¸»é¢˜</span>
          <select id="colorScheme" style="flex:1;min-width:200px;max-width:400px;background:var(--input-bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-size:14px;cursor:pointer">
            <option value="lost_temple" selected>å­¤å¯º Lost Temple</option>
            <option value="google">Google</option>
            <option value="native">ç³»ç»ŸåŸç”Ÿ</option>
            <option value="aqua">ç¢§æ°´ Aqua</option>
            <option value="azure">é’å¤© Azure</option>
            <option value="luna">æ˜æœˆ Luna</option>
            <option value="ink">å¢¨æ±  Ink</option>
            <option value="dark_temple">æš—å ‚ Dark Temple</option>
            <option value="starcraft">æ˜Ÿé™…äº‰éœ¸ StarCraft</option>
            <option value="clean_white">çº¯ç™½ Clean White</option>
            <option value="apathy">å†·æ¼  Apathy</option>
            <option value="dust">å¾®å°˜ Dust</option>
            <option value="solarized_rock">Solarized Rock</option>
            <option value="solarized_light">Solarized Light</option>
          </select>
        </label>
        <label>
          <span class="label-text">æ·±è‰²æ¨¡å¼ä¸»é¢˜</span>
          <select id="colorSchemeDark" style="flex:1;min-width:200px;max-width:400px;background:var(--input-bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-size:14px;cursor:pointer">
            <option value="dark_temple">æš—å ‚ Dark Temple</option>
            <option value="mojave_dark">Mojave Dark</option>
            <option value="solarized_dark">Solarized Dark</option>
            <option value="ink">å¢¨æ±  Ink</option>
            <option value="purity_of_form">Purity of Form</option>
            <option value="starcraft">æ˜Ÿé™…äº‰éœ¸ StarCraft</option>
            <option value="google">Google</option>
            <option value="apathy">å†·æ¼  Apathy</option>
          </select>
        </label>
        <div class="muted">ç³»ç»Ÿå¤–è§‚åˆ‡æ¢æ—¶è‡ªåŠ¨ä½¿ç”¨å¯¹åº”ä¸»é¢˜</div>
      </div>

      <div class="section">
        <h2>å€™é€‰çª—å£å¸ƒå±€</h2>
        <div class="radio-wrap">
          <label><input type="radio" name="candidateLayout" value="linear" checked /> æ¨ªå‘æ’åˆ—</label>
          <label><input type="radio" name="candidateLayout" value="stacked" /> çºµå‘æ’åˆ—</label>
        </div>
        <label style="margin-top:12px">
          <input class="switch" id="inlinePreedit" type="checkbox" checked />
          <span class="label-text">å•è¡Œæ¨¡å¼ (inline_preedit)</span>
        </label>
        <div class="muted">æ¨ªå‘æ’åˆ—æ›´ç´§å‡‘ï¼Œçºµå‘æ’åˆ—æ›´æ¸…æ™°</div>
      </div>
    </div>

    <div class="grid" style="margin-top:24px">
      <div class="section">
        <h2>å­—ä½“è®¾ç½®</h2>
        <label>
          <span class="label-text">ä¸»å­—ä½“</span>
          <input id="fontFace" type="text" value="PingFangSC" placeholder="PingFangSC, Hiragino Sans GB" />
        </label>
        <label>
          <span class="label-text">å­—ä½“å¤§å°</span>
          <input id="fontSize" type="number" min="10" max="36" value="16" style="max-width:100px" />
        </label>
        <div class="muted">å¸¸ç”¨å­—ä½“ï¼šPingFangSC, STHeiti, Hiragino Sans GB</div>
      </div>

      <div class="section">
        <h2>çª—å£å¤–è§‚</h2>
        <label>
          <span class="label-text">åœ†è§’åŠå¾„</span>
          <input id="cornerRadius" type="number" min="0" max="20" value="5" style="max-width:100px" />
        </label>
        <label>
          <span class="label-text">è¡Œé—´è·</span>
          <input id="lineSpacing" type="number" min="0" max="20" value="5" style="max-width:100px" />
        </label>
        <label>
          <span class="label-text">å€™é€‰è¯é—´è·</span>
          <input id="spacing" type="number" min="0" max="20" value="8" style="max-width:100px" />
        </label>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>è½½å…¥ç°æœ‰é…ç½®ï¼ˆå¯é€‰ï¼‰</h2>
    <div id="drop" class="drop">
      <div style="font-size:16px;margin-bottom:8px">ğŸ“ æ‹–æ‹½ <code>*.custom.yaml</code> æ–‡ä»¶åˆ°æ­¤å¤„</div>
      <div class="muted">è‡ªåŠ¨è§£æå¹¶å¡«å……é…ç½®é€‰é¡¹</div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:16px">
      <h2 style="margin:0">ç”Ÿæˆçš„ YAML é¢„è§ˆ</h2>
      <div style="display:flex;gap:8px">
        <button id="btnGenSchema">â¬‡ ç”Ÿæˆæ–¹æ¡ˆé…ç½®</button>
        <button id="btnGenSquirrel">â¬‡ ç”Ÿæˆçš®è‚¤é…ç½®</button>
      </div>
    </div>
    <div class="radio-wrap" style="margin-bottom:16px">
      <label><input type="radio" name="previewType" value="schema" checked /> æ–¹æ¡ˆé…ç½®é¢„è§ˆ</label>
      <label><input type="radio" name="previewType" value="squirrel" /> çš®è‚¤é…ç½®é¢„è§ˆ</label>
    </div>
    <textarea id="preview" readonly></textarea>
    <div class="hint">
      <strong>éƒ¨ç½²è¯´æ˜ï¼š</strong>
      <div style="margin-top:8px">
        <strong>æ–¹å¼ 1ï¼š</strong>å°†ä¸‹è½½çš„æ–‡ä»¶æ”¾å…¥ <code>~/Library/Rime/</code> ç›®å½•ï¼Œç„¶ååœ¨ã€Œé¼ é¡»ç®¡ã€èœå•ä¸­ç‚¹å‡»ã€Œé‡æ–°éƒ¨ç½²ã€ã€‚
      </div>
      <div style="margin-top:8px">
        <strong>æ–¹å¼ 2ï¼š</strong>å‘½ä»¤è¡Œå¿«é€Ÿéƒ¨ç½²
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <code id="deployCmd" style="flex:1;padding:8px 12px;background:#0a0e14;cursor:pointer;user-select:all">/Library/Input\ Methods/Squirrel.app/Contents/MacOS/Squirrel --reload</code>
          <button id="copyCmd" style="padding:8px 16px;font-size:12px">ğŸ“‹ å¤åˆ¶</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const el = (id)=>document.getElementById(id);
  const schemaId = el('schemaId');
  const outName = el('outName');
  const hotkey = el('hotkey');
  const asciiMode = el('asciiMode');
  const fullShape = el('fullShape');
  const asciiPunct = el('asciiPunct');
  const pageSize = el('pageSize');
  const customLabels = el('customLabels');
  const customLabelsWrap = el('customLabelsWrap');
  const asciiComposer = el('asciiComposer');
  const enableEmail = el('enableEmail');
  const enableUrl = el('enableUrl');
  const enableUppercase = el('enableUppercase');
  const enablePunctuator = el('enablePunctuator');
  const enableEmoji = el('enableEmoji');
  const enableLunar = el('enableLunar');
  const enableSymbols = el('enableSymbols');
  // çš®è‚¤é…ç½®å…ƒç´ 
  const colorScheme = el('colorScheme');
  const colorSchemeDark = el('colorSchemeDark');
  const fontFace = el('fontFace');
  const fontSize = el('fontSize');
  const cornerRadius = el('cornerRadius');
  const lineSpacing = el('lineSpacing');
  const spacing = el('spacing');
  const inlinePreedit = el('inlinePreedit');
  const preview = el('preview');
  const drop = el('drop');

  // åˆ‡æ¢è‡ªå®šä¹‰æ ‡ç­¾è¾“å…¥æ¡†æ˜¾ç¤º
  document.querySelectorAll('input[name="selectLabels"]').forEach(radio=>{
    radio.addEventListener('change', ()=>{
      customLabelsWrap.style.display = radio.value === 'custom' ? 'flex' : 'none';
      updatePreview();
    });
  });

  // å¿«æ·é”®å½•åˆ¶åŠŸèƒ½
  let isRecording = false;
  const recordBtn = document.getElementById('recordHotkey');

  recordBtn.addEventListener('click', ()=>{
    if(isRecording){
      // åœæ­¢å½•åˆ¶
      isRecording = false;
      recordBtn.textContent = 'ğŸ¹ å½•åˆ¶';
      recordBtn.style.background = '';
      hotkey.removeAttribute('readonly');
      return;
    }

    // å¼€å§‹å½•åˆ¶
    isRecording = true;
    recordBtn.textContent = 'âº å½•åˆ¶ä¸­...';
    recordBtn.style.background = '#dc3545';
    hotkey.value = 'æŒ‰ä¸‹å¿«æ·é”®...';
    hotkey.focus();
  });

  hotkey.addEventListener('keydown', (e)=>{
    if(!isRecording) return;

    e.preventDefault();
    const keys = [];

    // ä¿®é¥°é”®
    if(e.ctrlKey || e.metaKey) keys.push('Control');
    if(e.shiftKey) keys.push('Shift');
    if(e.altKey) keys.push('Alt');

    // ä¸»é”®
    const mainKey = e.key;
    if(mainKey && !['Control','Shift','Alt','Meta'].includes(mainKey)){
      // ç‰¹æ®Šé”®åæ˜ å°„
      const keyMap = {
        ' ': 'space',
        'Enter': 'Return',
        'ArrowUp': 'Up',
        'ArrowDown': 'Down',
        'ArrowLeft': 'Left',
        'ArrowRight': 'Right',
        'Escape': 'Escape',
        '`': 'grave',
        '-': 'minus',
        '=': 'equal',
        '[': 'bracketleft',
        ']': 'bracketright',
        '\\': 'backslash',
        ';': 'semicolon',
        "'": 'apostrophe',
        ',': 'comma',
        '.': 'period',
        '/': 'slash'
      };

      const mappedKey = keyMap[mainKey] || mainKey.toUpperCase();
      keys.push(mappedKey);

      // ç”Ÿæˆçƒ­é”®å­—ç¬¦ä¸²
      const hotkeyStr = keys.join('+');
      hotkey.value = hotkeyStr;

      // åœæ­¢å½•åˆ¶
      setTimeout(()=>{
        isRecording = false;
        recordBtn.textContent = 'ğŸ¹ å½•åˆ¶';
        recordBtn.style.background = '';
        hotkey.removeAttribute('readonly');
        updatePreview();
      }, 300);
    }
  });

  function getSimpDefault(){
    const v = document.querySelector('input[name="simp"]:checked').value;
    return v === 'simp' ? 1 : 0; // reset:1 ç®€ä½“ï¼›0 ç¹ä½“
  }

  function getSelectLabels(){
    const labelType = document.querySelector('input[name="selectLabels"]:checked').value;
    if(labelType === 'custom' && customLabels.value.trim()){
      return customLabels.value.trim().split(/\s+/).filter(Boolean);
    }
    // é»˜è®¤æ•°å­—æ ‡ç­¾
    const size = parseInt(pageSize.value) || 9;
    return Array.from({length: size}, (_, i) => i + 1);
  }

  function renderYaml(){
    const hk = hotkey.value.split(',')
      .map(s=>s.trim()).filter(Boolean);

    const yamlObj = {
      patch: {
        schema: {
          name: getSimpDefault() === 1 ? 'æœ™æœˆæ‹¼éŸ³ï¼ˆç°¡é«”å„ªå…ˆï¼‰' : 'æœ™æœˆæ‹¼éŸ³ï¼ˆç¹é«”å„ªå…ˆï¼‰',
          description: (getSimpDefault() === 1
            ? 'é è¨­è¼¸å‡ºç°¡é«”ï¼Œå¯ç”¨ç†±éµåœ¨ç°¡ç¹é–“åˆ‡æ›ã€‚'
            : 'é è¨­è¼¸å‡ºç¹é«”ï¼Œå¯ç”¨ç†±éµåœ¨ç°¡ç¹é–“åˆ‡æ›ã€‚')
        },
        switches: [
          { name: 'ascii_mode', reset: asciiMode.checked ? 0 : 1, states: [' ä¸­æ–‡',' è¥¿æ–‡'] },
          { name: 'full_shape', reset: fullShape.checked ? 1 : 0, states: [' åŠè§’',' å…¨è§’'] },
          { name: 'simplification', reset: getSimpDefault(), states: [' ç®€ä½“',' ç¹é«”'] },
          { name: 'ascii_punct', reset: asciiPunct.checked ? 0 : 1, states: [' ã€‚ï¼Œ',' ï¼ï¼Œ'] }
        ].concat(
          enableEmoji.checked ? [{ name: 'emoji', reset: 1, states: ['ğŸˆšï¸','ğŸˆ¶ï¸'] }] : [],
          enableLunar.checked ? [{ name: 'lunar', reset: 0, states: ['â˜€ï¸','ğŸŒ™'] }] : []
        ),
        switcher: {
          caption: 'æ–¹æ¡ˆé¸å–®',
          hotkeys: hk.length ? hk : ['Control+Shift+F'],
          abbreviate_options: true,
          option_list_separator: 'ï¼'
        },
        key_binder: {
          import_preset: 'default',
          bindings: [
            { when: 'composing', accept: (hk[0]||'Control+Shift+F'), toggle: 'simplification' }
          ]
        },
        menu: {
          alternative_select_labels: getSelectLabels(),
          page_size: parseInt(pageSize.value) || 9
        }
      }
    };

    // Punctuator æ ‡ç‚¹ç¬¦å·è®¾ç½®
    if(enablePunctuator.checked){
      yamlObj.patch.punctuator = { import_preset: 'default' };
    }

    // ASCII composer è®¾ç½®
    if(asciiComposer.checked){
      yamlObj.patch.ascii_composer = { good_old_caps_lock: true };
    }

    // Recognizer patterns
    const patterns = {};
    if(enableEmail.checked){
      patterns.email = "^[A-Za-z][-_.0-9A-Za-z]*@.*$";
    }
    if(enableUrl.checked){
      patterns.url = "^(www[.]|https?:|ftp[.:]|mailto:|file:).*$|^[a-z]+[.].+$";
    }
    if(enableUppercase.checked){
      patterns.uppercase = "[A-Z][-_+.'0-9A-Za-z]*$";
    }
    if(Object.keys(patterns).length > 0){
      yamlObj.patch.recognizer = { patterns };
    }

    // Emoji å’Œå†œå†æ”¯æŒçš„å¼•æ“é…ç½®
    if(enableEmoji.checked || enableLunar.checked){
      const translators = [
        'punct_translator',
        'script_translator'
      ];

      if(enableEmoji.checked){
        translators.push('table_translator@emoji');
      }
      if(enableLunar.checked){
        translators.push('lua_translator@date_translator');
        translators.push('lua_translator@lunar_translator');
      }

      yamlObj.patch['engine/translators'] = translators;
    }

    // Emoji é…ç½®
    if(enableEmoji.checked){
      yamlObj.patch.emoji = {
        dictionary: 'emoji',
        enable_completion: false,
        prefix: '/',
        suffix: '/',
        tips: 'ã€”è¡¨æƒ…ã€•',
        tag: 'emoji'
      };
    }

    // å†œå†å’Œæ—¥æœŸçš„è¯†åˆ«æ¨¡å¼
    if(enableLunar.checked){
      if(!yamlObj.patch.recognizer){
        yamlObj.patch.recognizer = { patterns: {} };
      }
      if(!yamlObj.patch.recognizer.patterns){
        yamlObj.patch.recognizer.patterns = {};
      }
      yamlObj.patch.recognizer.patterns.date = "^rq$";
      yamlObj.patch.recognizer.patterns.lunar = "^nl$";
    }

    // ç¬¦å·è¾“å…¥é…ç½®
    if(enableSymbols.checked){
      yamlObj.patch['punctuator/symbols'] = {
        '/ydy': ['â‰ˆ'],
        '/bdy': ['â‰ '],
        '/xdy': ['â‰¤', 'â©½'],
        '/gdy': ['â‰¥', 'â©¾'],
        '/jh': ['Â±', 'ï¼‹', 'ï¼', 'Ã—', 'Ã·', 'âˆ“'],
        '/wq': ['âˆ', 'âˆ«', 'âˆ®', 'âˆ‘', 'âˆ'],
        '/jh2': ['ï¼', 'â‰¡', 'â‰Œ', 'â‰ˆ'],
        '/px': ['âŠ¥', 'âˆ¥', 'âˆ ', 'âŒ’', 'âŠ™', 'â—‹', 'â—'],
        '/jj': ['âˆµ', 'âˆ´', 'âˆ·'],
        '/zs': ['â†‘', 'â†“', 'â†', 'â†’', 'â†–', 'â†—', 'â†™', 'â†˜', 'â†”', 'â†•'],
        '/sx': ['â‡‘', 'â‡“', 'â‡', 'â‡’', 'â‡–', 'â‡—', 'â‡™', 'â‡˜', 'â‡”', 'â‡•'],
        '/dh': ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£', 'â‘¤', 'â‘¥', 'â‘¦', 'â‘§', 'â‘¨', 'â‘©'],
        '/xh': ['â‘´', 'â‘µ', 'â‘¶', 'â‘·', 'â‘¸', 'â‘¹', 'â‘º', 'â‘»', 'â‘¼', 'â‘½'],
        '/xm': ['â… ', 'â…¡', 'â…¢', 'â…£', 'â…¤', 'â…¥', 'â…¦', 'â…§', 'â…¨', 'â…©', 'â…ª', 'â…«'],
        '/xxm': ['â…°', 'â…±', 'â…²', 'â…³', 'â…´', 'â…µ', 'â…¶', 'â…·', 'â…¸', 'â…¹'],
        '/dw': ['Â°', 'â„ƒ', 'â„‰', 'â€°', 'â€±', 'ã¡', 'ã¥', 'ã', 'ã', 'ãœ'],
        '/bz': ['$', 'Â¥', 'â‚¬', 'Â£', 'Â¢', 'â‚©'],
        '/xh2': ['â€»', 'â˜…', 'â˜†', 'â—‹', 'â—', 'â—', 'â—‡', 'â—†', 'â–¡', 'â– ', 'â–³', 'â–²', 'â–½', 'â–¼'],
        '/fh': ['â™ ', 'â™£', 'â™¥', 'â™¦'],
        '/ts': ['â™©', 'â™ª', 'â™«', 'â™¬', 'â™­', 'â™®', 'â™¯'],
        '/sx2': ['Î‘', 'Î’', 'Î“', 'Î”', 'Î•', 'Î–', 'Î—', 'Î˜', 'Î™', 'Îš', 'Î›', 'Îœ', 'Î', 'Î', 'ÎŸ', 'Î ', 'Î¡', 'Î£', 'Î¤', 'Î¥', 'Î¦', 'Î§', 'Î¨', 'Î©'],
        '/xx': ['Î±', 'Î²', 'Î³', 'Î´', 'Îµ', 'Î¶', 'Î·', 'Î¸', 'Î¹', 'Îº', 'Î»', 'Î¼', 'Î½', 'Î¾', 'Î¿', 'Ï€', 'Ï', 'Ïƒ', 'Ï„', 'Ï…', 'Ï†', 'Ï‡', 'Ïˆ', 'Ï‰'],
        '/py': ['Ä', 'Ã¡', 'Ç', 'Ã ', 'Ä“', 'Ã©', 'Ä›', 'Ã¨', 'Ä«', 'Ã­', 'Ç', 'Ã¬', 'Å', 'Ã³', 'Ç’', 'Ã²', 'Å«', 'Ãº', 'Ç”', 'Ã¹', 'Ç–', 'Ç˜', 'Çš', 'Çœ', 'Ã¼', 'Ãª', 'Å„', 'Åˆ', 'Ç¹']
      };
    }

    return yamlObj;
  }

  function renderSquirrelYaml(){
    const candidateLayout = document.querySelector('input[name="candidateLayout"]:checked').value;

    const squirrelObj = {
      patch: {
        show_notifications_when: 'appropriate',
        style: {
          color_scheme: colorScheme.value,
          color_scheme_dark: colorSchemeDark.value,
          candidate_list_layout: candidateLayout,
          text_orientation: 'horizontal',
          inline_preedit: inlinePreedit.checked,
          corner_radius: parseInt(cornerRadius.value) || 5,
          line_spacing: parseInt(lineSpacing.value) || 5,
          spacing: parseInt(spacing.value) || 8,
          font_face: fontFace.value || 'PingFangSC',
          font_point: parseInt(fontSize.value) || 16
        }
      }
    };

    return squirrelObj;
  }

  function generateEmojiDict(){
    return `---
name: emoji
version: "1.0"
sort: by_weight
use_preset_vocabulary: false
...

# å¸¸ç”¨ Emoji è¯åº“

# è¡¨æƒ…
ğŸ˜€	xiaolian	1
ğŸ˜	luochilexiao	1
ğŸ˜‚	xikulian	1
ğŸ¤£	gundilexiao	1
ğŸ˜ƒ	zhangzuilexiao	1
ğŸ˜„	meixiaolexiao	1
ğŸ˜…	dahan	1
ğŸ˜†	mizhuilexiao	1
ğŸ˜Š	weixiao	1
ğŸ˜‰	zhayan	1
ğŸ˜	aixin	1
ğŸ˜˜	qinqin	1
ğŸ˜‹	chankou	1
ğŸ˜	taiyanjing	1
ğŸ¤”	sikao	1
ğŸ˜	wubiaojing	1
ğŸ˜‘	wuyu	1
ğŸ˜¶	wuhua	1
ğŸ™„	fanbaiyuan	1
ğŸ˜	huaixiao	1
ğŸ˜£	jianjue	1
ğŸ˜¥	shiwang	1
ğŸ˜®	jingya	1
ğŸ˜¯	chijing	1
ğŸ˜ª	kunle	1
ğŸ˜«	pituan	1
ğŸ˜´	shuijiao	1
ğŸ˜Œ	manzu	1

# æ‰‹åŠ¿
ğŸ‘	zan	1
ğŸ‘	cai	1
ğŸ‘Œ	ok	1
âœŒï¸	shou	1
ğŸ¤	jiaocha	1
ğŸ¤Ÿ	aini	1
ğŸ¤˜	yaogun	1
ğŸ‘	guzhang	1
ğŸ™Œ	jubei	1
ğŸ‘	zhangkai	1
ğŸ¤	woshou	1
ğŸ™	qidao	1
âœŠ	quantou	1
ğŸ‘Š	chuiquan	1
ğŸ¤›	zuoquan	1
ğŸ¤œ	youquan	1

# å¿ƒå½¢
â¤ï¸	aixin	2
ğŸ’”	xinpo	1
ğŸ’•	aixin	1
ğŸ’–	aixin	1
ğŸ’—	aixin	1
ğŸ’˜	aixin	1
ğŸ’™	lanxin	1
ğŸ’š	lvxin	1
ğŸ’›	huangxin	1
ğŸ§¡	chengxin	1
ğŸ’œ	zixin	1
ğŸ–¤	heixin	1
ğŸ¤	baixxin	1

# åŠ¨ç‰©
ğŸ¶	gou	1
ğŸ±	mao	1
ğŸ­	laoshu	1
ğŸ¹	cangxhu	1
ğŸ°	tuzi	1
ğŸ¦Š	huhu	1
ğŸ»	xiong	1
ğŸ¼	xiongmao	1
ğŸ¨	kaola	1
ğŸ¯	laohu	1
ğŸ¦	shizi	1
ğŸ®	niu	1
ğŸ·	zhu	1
ğŸ¸	qingwa	1
ğŸµ	houzi	1
ğŸ”	ji	1
ğŸ§	qie	1
ğŸ¦	niao	1
ğŸ¦†	ya	1
ğŸº	lang	1
ğŸ—	yezhu	1
ğŸ´	ma	1
ğŸ¦„	dujiaoshou	1
ğŸ	mifeng	1
ğŸ›	chongzi	1
ğŸ¦‹	hudie	1
ğŸŒ	wonziu	1
ğŸ	piaochong	1
ğŸ¢	wugui	1
ğŸ	she	1
ğŸ™	zhangyu	1
ğŸ¦€	xie	1
ğŸ 	yu	1
ğŸŸ	yu	1
ğŸ¬	haitun	1
ğŸ³	jingyu	1
ğŸ¦ˆ	shayu	1

# é£Ÿç‰©
ğŸ	pingguo	1
ğŸŠ	juzi	1
ğŸ‹	ningmeng	1
ğŸŒ	xiangjiao	1
ğŸ‰	xigua	1
ğŸ‡	putao	1
ğŸ“	caomei	1
ğŸ’	yingtao	1
ğŸ‘	taozi	1
ğŸ	boluo	1
ğŸ¥­	mangguo	1
ğŸ¥	mihoutao	1
ğŸ…	xihongshi	1
ğŸ¥‘	niuyouguo	1
ğŸ¥¦	xilan	1
ğŸ¥’	huanggua	1
ğŸŒ¶ï¸	lajiao	1
ğŸŒ½	yumi	1
ğŸ¥•	huluobu	1
ğŸ¥”	tudou	1
ğŸ	mianbao	1
ğŸ¥	niujiao	1
ğŸ§€	nailao	1
ğŸ¥š	jidan	1
ğŸ³	jidan	1
ğŸ¥“	bacon	1
ğŸ¥©	rou	1
ğŸ—	jitui	1
ğŸ–	rou	1
ğŸŒ­	regou	1
ğŸ”	hanbao	1
ğŸŸ	shutiao	1
ğŸ•	pisa	1
ğŸ¥ª	sanmingzhi	1
ğŸŒ®	taco	1
ğŸ¥—	shala	1
ğŸ	yidali	1
ğŸœ	mian	1
ğŸ²	guo	1
ğŸ›	gali	1
ğŸ£	shousi	1
ğŸ±	biandang	1
ğŸ¥Ÿ	jiaozi	1
ğŸ¤	xia	1
ğŸ™	fantuan	1
ğŸš	mifan	1
ğŸ¥®	yuebing	1
ğŸ¦	bingqilin	1
ğŸ§	bingsha	1
ğŸ¨	bingqilin	1
ğŸ©	tianquan	1
ğŸª	binggan	1
ğŸ‚	dangao	1
ğŸ°	dangao	1
ğŸ«	qiaokeli	1
ğŸ¬	tang	1
ğŸ­	tangguo	1
ğŸ¯	fengmi	1
ğŸ¼	naiping	1
â˜•	kafei	1
ğŸµ	cha	1
ğŸ¥¤	yinliao	1
ğŸ¶	jiu	1
ğŸº	pijiu	1
ğŸ»	pijiu	1
ğŸ¥‚	xiangbin	1
ğŸ·	hongjiu	1
ğŸ¥ƒ	weishiji	1
ğŸ¸	jiweiiju	1
ğŸ¹	yinliao	1
ğŸ¾	xiangbin	1

# äº¤é€š
ğŸš—	qiche	1
ğŸš•	chuzuche	1
ğŸš™	suv	1
ğŸšŒ	gongjiao	1
ğŸš	dianche	1
ğŸš	mianbao	1
ğŸš‘	jiuhuche	1
ğŸš’	xiaofangche	1
ğŸš“	jingche	1
ğŸšš	huoche	1
ğŸš›	tuoche	1
ğŸï¸	saiche	1
ğŸšœ	tuolaji	1
ğŸ›µ	motuoche	1
ğŸš²	zixingche	1
âœˆï¸	feiji	1
ğŸš€	huojian	1
ğŸš	zhishengji	1
ğŸš‚	huoche	1
ğŸšƒ	dieche	1
ğŸš„	gaotie	1
ğŸš…	gaotie	1
ğŸš†	huoche	1
ğŸš‡	ditie	1
ğŸšˆ	ditie	1
ğŸš‰	che	1
ğŸšŠ	dianche	1
ğŸš	ditie	1
ğŸš	shan	1
ğŸš‹	dianche	1
ğŸšŒ	bus	1
ğŸš	bus	1
ğŸš	dianche	1
ğŸš	xiaoche	1
â›µ	chuang	1
ğŸš¤	kuaiting	1
â›´ï¸	lunchuan	1
ğŸ›³ï¸	youlun	1
ğŸš¢	chuan	1

# ç¬¦å·
â­	xing	1
ğŸŒŸ	xing	1
âœ¨	shanshuo	1
âš¡	shandian	1
ğŸ”¥	huo	1
ğŸ’§	shui	1
ğŸŒŠ	lang	1
ğŸ‰	qingzhu	1
ğŸŠ	caidai	1
ğŸˆ	qiqiu	1
ğŸ	liwu	1
ğŸ€	hudiejie	1
ğŸµ	yinyue	1
ğŸ¶	yinyue	1
ğŸ¤	maike	1
ğŸ§	erji	1
ğŸ“±	shouji	1
ğŸ’»	diannao	1
âŒ¨ï¸	jianpan	1
ğŸ–±ï¸	shubiao	1
ğŸ–¨ï¸	dayinji	1
ğŸ“·	xiangji	1
ğŸ“¹	shexiangji	1
ğŸ“º	dianshi	1
ğŸ“»	shouyinji	1
â°	naozhong	1
â±ï¸	jishiqi	1
â²ï¸	shijian	1
ğŸ•°ï¸	zhong	1
ğŸ“–	shu	1
ğŸ“š	shu	1
ğŸ“	biji	1
ğŸ“„	wenjian	1
ğŸ“ƒ	wenjian	1
ğŸ“‹	jiandian	1
ğŸ“Œ	dingzhen	1
ğŸ“	weizhi	1
âœ…	duihao	1
âŒ	cha	1
â	cha	1
âœ”ï¸	dui	1
â˜‘ï¸	xuanzhong	1
âš ï¸	jinggao	1
ğŸš«	jinzhi	1
â›”	jinzhi	1
ğŸ”	shiba	1
ğŸ“µ	shoujijin	1
ğŸš­	jingyan	1
â™»ï¸	huishou	1
`;
  }

  function generateRimeLua(){
    return `-- Rime Lua æ‰©å±•è„šæœ¬
-- æ—¥æœŸæ—¶é—´å’Œå†œå†åŠŸèƒ½

-- æ—¥æœŸè½¬æ¢å™¨
function date_translator(input, seg)
    if input == "rq" then
        local year = os.date("%Y")
        local month = os.date("%m")
        local day = os.date("%d")
        local time = os.date("%H:%M:%S")
        local week_map = {"æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"}
        local week = "æ˜ŸæœŸ" .. week_map[tonumber(os.date("%w")) + 1]

        -- ä¸­æ–‡æ—¥æœŸæ ¼å¼
        yield(Candidate("date", seg.start, seg._end,
            year .. "å¹´" .. month .. "æœˆ" .. day .. "æ—¥",
            "ã€”æ—¥æœŸã€•"))

        -- ä¸­æ–‡æ—¥æœŸ + æ˜ŸæœŸ
        yield(Candidate("date", seg.start, seg._end,
            year .. "å¹´" .. month .. "æœˆ" .. day .. "æ—¥ " .. week,
            "ã€”æ—¥æœŸ+æ˜ŸæœŸã€•"))

        -- ä¸­æ–‡æ—¥æœŸ + æ—¶é—´
        yield(Candidate("date", seg.start, seg._end,
            year .. "å¹´" .. month .. "æœˆ" .. day .. "æ—¥ " .. time,
            "ã€”æ—¥æœŸ+æ—¶é—´ã€•"))

        -- ISO æ—¥æœŸæ ¼å¼
        yield(Candidate("date", seg.start, seg._end,
            os.date("%Y-%m-%d"),
            "ã€”ISOæ—¥æœŸã€•"))

        -- æ–œæ æ—¥æœŸæ ¼å¼
        yield(Candidate("date", seg.start, seg._end,
            os.date("%Y/%m/%d"),
            "ã€”æ–œæ æ—¥æœŸã€•"))

        -- æ—¶é—´æˆ³
        yield(Candidate("date", seg.start, seg._end,
            tostring(os.time()),
            "ã€”æ—¶é—´æˆ³ã€•"))
    end
end

-- å†œå†è½¬æ¢å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
function lunar_translator(input, seg)
    if input == "nl" then
        -- å¤©å¹²åœ°æ”¯å¹´ä»½
        local tian_gan = {"ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"}
        local di_zhi = {"å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"}
        local sheng_xiao = {"é¼ ", "ç‰›", "è™", "å…”", "é¾™", "è›‡", "é©¬", "ç¾Š", "çŒ´", "é¸¡", "ç‹—", "çŒª"}

        local year = tonumber(os.date("%Y"))
        local tian_index = ((year - 4) % 10) + 1
        local di_index = ((year - 4) % 12) + 1

        local gan_zhi = tian_gan[tian_index] .. di_zhi[di_index]
        local xiao = sheng_xiao[di_index]

        yield(Candidate("lunar", seg.start, seg._end,
            gan_zhi .. "å¹´ (" .. xiao .. "å¹´)",
            "ã€”å†œå†å¹´ä»½ã€•"))

        yield(Candidate("lunar", seg.start, seg._end,
            year .. " " .. xiao .. "å¹´",
            "ã€”ç”Ÿè‚–ã€•"))

        -- èŠ‚æ°”æç¤º
        local month = tonumber(os.date("%m"))
        local jie_qi_map = {
            "ç«‹æ˜¥/é›¨æ°´", "æƒŠè›°/æ˜¥åˆ†", "æ¸…æ˜/è°·é›¨",
            "ç«‹å¤/å°æ»¡", "èŠ’ç§/å¤è‡³", "å°æš‘/å¤§æš‘",
            "ç«‹ç§‹/å¤„æš‘", "ç™½éœ²/ç§‹åˆ†", "å¯’éœ²/éœœé™",
            "ç«‹å†¬/å°é›ª", "å¤§é›ª/å†¬è‡³", "å°å¯’/å¤§å¯’"
        }
        yield(Candidate("lunar", seg.start, seg._end,
            "æœ¬æœˆèŠ‚æ°”ï¼š" .. jie_qi_map[month],
            "ã€”èŠ‚æ°”ã€•"))
    end
end
`;
  }

  function updatePreview(){
    const previewType = document.querySelector('input[name="previewType"]:checked').value;
    if(previewType === 'schema'){
      const yamlObj = renderYaml();
      preview.value = jsyaml.dump(yamlObj, {lineWidth: 120});
      outName.textContent = `${schemaId.value || 'luna_pinyin'}.custom.yaml`;
    } else {
      const squirrelObj = renderSquirrelYaml();
      preview.value = jsyaml.dump(squirrelObj, {lineWidth: 120});
      outName.textContent = 'squirrel.custom.yaml';
    }
  }

  function download(text, filename){
    const blob = new Blob([text], {type: 'text/yaml;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function parseYamlAndFill(yamlText){
    try{
      const data = jsyaml.load(yamlText);
      const p = data && data.patch ? data.patch : data;
      if(!p){ return; }

      // å°è¯•ä»ç°æœ‰å€¼å›å¡«
      const sw = (p.switches||[]).reduce((m,x)=>{ m[x.name]=x; return m; },{});
      if(sw.simplification){ // reset:1 ç®€ä½“ï¼›0 ç¹ä½“
        const simp = sw.simplification.reset === 1 ? 'simp' : 'trad';
        document.querySelector(`input[name="simp"][value="${simp}"]`).checked = true;
      }
      if(sw.ascii_mode){ asciiMode.checked = (sw.ascii_mode.reset===0); }
      if(sw.full_shape){ fullShape.checked = (sw.full_shape.reset===1); }
      if(sw.ascii_punct){ asciiPunct.checked = (sw.ascii_punct.reset===0); }

      if(p.switcher && Array.isArray(p.switcher.hotkeys) && p.switcher.hotkeys.length){
        hotkey.value = p.switcher.hotkeys.join(', ');
      }

      // å›å¡« menu è®¾ç½®
      if(p.menu){
        if(p.menu.page_size){ pageSize.value = p.menu.page_size; }
        if(Array.isArray(p.menu.alternative_select_labels)){
          const labels = p.menu.alternative_select_labels;
          // æ£€æŸ¥æ˜¯å¦ä¸ºæ•°å­—æ ‡ç­¾
          const isNumber = labels.every(l => typeof l === 'number');
          if(isNumber){
            document.querySelector('input[name="selectLabels"][value="number"]').checked = true;
          } else {
            document.querySelector('input[name="selectLabels"][value="custom"]').checked = true;
            customLabels.value = labels.join(' ');
            customLabelsWrap.style.display = 'flex';
          }
        }
      }

      // å›å¡« ascii_composer è®¾ç½®
      if(p.ascii_composer && p.ascii_composer.good_old_caps_lock !== undefined){
        asciiComposer.checked = p.ascii_composer.good_old_caps_lock;
      }

      // å›å¡« recognizer è®¾ç½®
      if(p.recognizer && p.recognizer.patterns){
        enableEmail.checked = !!p.recognizer.patterns.email;
        enableUrl.checked = !!p.recognizer.patterns.url;
        enableUppercase.checked = !!p.recognizer.patterns.uppercase;
      }

      updatePreview();
    }catch(e){
      alert('è§£æ YAML å¤±è´¥ï¼š' + e.message);
    }
  }

  // é¢„è§ˆç±»å‹åˆ‡æ¢
  document.querySelectorAll('input[name="previewType"]').forEach(radio=>{
    radio.addEventListener('change', updatePreview);
  });

  // åˆå§‹åŒ–
  ['change','input'].forEach(evt=>{
    document.addEventListener(evt, (e)=>{
      updatePreview();
    });
  });
  updatePreview();

  // æ‹–æ‹½è¯»å–ç°æœ‰ custom.yaml
  ;['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); });
  });
  ;['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); });
  });
  drop.addEventListener('drop', async (e)=>{
    const file = e.dataTransfer.files[0];
    if(!file) return;
    const text = await file.text();
    parseYamlAndFill(text);
    // è‹¥æ–‡ä»¶ååƒ xxx.custom.yamlï¼Œå°è¯•å¡«å…… schemaId
    const m = file.name.match(/^(.+)\.custom\.yaml$/i);
    if(m){ schemaId.value = m[1]; }
    updatePreview();
  });

  // ç”Ÿæˆå¹¶ä¸‹è½½ - æ–¹æ¡ˆé…ç½®
  document.getElementById('btnGenSchema').addEventListener('click', ()=>{
    const yamlObj = renderYaml();
    const yamlText = jsyaml.dump(yamlObj, {lineWidth: 120});
    const name = `${schemaId.value || 'luna_pinyin'}.custom.yaml`;
    download(yamlText, name);

    // å¦‚æœå¯ç”¨äº† Emojiï¼Œä¸‹è½½ emoji è¯åº“
    if(enableEmoji.checked){
      const emojiDict = generateEmojiDict();
      download(emojiDict, 'emoji.dict.yaml');
    }

    // å¦‚æœå¯ç”¨äº†å†œå†æˆ– Emojiï¼Œä¸‹è½½ rime.lua
    if(enableLunar.checked || enableEmoji.checked){
      const rimeLua = generateRimeLua();
      download(rimeLua, 'rime.lua');
    }
  });

  // ç”Ÿæˆå¹¶ä¸‹è½½ - çš®è‚¤é…ç½®
  document.getElementById('btnGenSquirrel').addEventListener('click', ()=>{
    const squirrelObj = renderSquirrelYaml();
    const yamlText = jsyaml.dump(squirrelObj, {lineWidth: 120});
    download(yamlText, 'squirrel.custom.yaml');
  });

  // å¤åˆ¶éƒ¨ç½²å‘½ä»¤
  document.getElementById('copyCmd').addEventListener('click', async ()=>{
    const cmd = document.getElementById('deployCmd').textContent;
    try{
      await navigator.clipboard.writeText(cmd);
      const btn = document.getElementById('copyCmd');
      const originalText = btn.textContent;
      btn.textContent = 'âœ“ å·²å¤åˆ¶';
      btn.style.background = '#28a745';
      setTimeout(()=>{
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    }catch(e){
      // é™çº§æ–¹æ¡ˆï¼šé€‰ä¸­æ–‡æœ¬
      const range = document.createRange();
      range.selectNode(document.getElementById('deployCmd'));
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);
    }
  });

  // ç‚¹å‡»å‘½ä»¤ä¹Ÿå¯ä»¥é€‰ä¸­
  document.getElementById('deployCmd').addEventListener('click', function(){
    const range = document.createRange();
    range.selectNode(this);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
  });
</script>
</body>
</html>