<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>符号编辑器测试</title>
    <style>
        body {
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>符号编辑器诊断测试</h1>

    <div class="test-section">
        <h2>1. DOM 元素检查</h2>
        <div id="dom-test"></div>
    </div>

    <div class="test-section">
        <h2>2. 事件监听器检查</h2>
        <div id="event-test"></div>
    </div>

    <div class="test-section">
        <h2>3. 模块加载检查</h2>
        <div id="module-test"></div>
    </div>

    <div class="test-section">
        <h2>4. 手动触发测试</h2>
        <button id="manual-test">手动打开符号配置弹窗</button>
        <div id="manual-result"></div>
    </div>

    <div class="test-section">
        <h2>5. 控制台输出</h2>
        <pre id="console-output"></pre>
    </div>

    <script type="module">
        const output = document.getElementById('console-output');
        const logMessages = [];

        // 捕获所有console输出
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            logMessages.push('[LOG] ' + args.join(' '));
            updateConsoleOutput();
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            logMessages.push('[ERROR] ' + args.join(' '));
            updateConsoleOutput();
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logMessages.push('[WARN] ' + args.join(' '));
            updateConsoleOutput();
        };

        function updateConsoleOutput() {
            output.textContent = logMessages.join('\n');
        }

        // 测试1: DOM元素检查
        async function testDOM() {
            const domTest = document.getElementById('dom-test');
            let html = '<h3>检查必要的DOM元素:</h3>';

            // 首先检查index.html是否存在
            try {
                const response = await fetch('/index.html');
                const text = await response.text();

                // 创建一个临时DOM来解析HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');

                const elements = [
                    { id: 'btnConfigSymbols', name: '配置按钮' },
                    { id: 'symbolModal', name: '符号弹窗' },
                    { id: 'symbolTableBody', name: '符号表格' },
                    { id: 'closeSymbolModal', name: '关闭按钮' },
                    { id: 'saveSymbols', name: '保存按钮' },
                    { id: 'cancelSymbols', name: '取消按钮' },
                    { id: 'resetSymbols', name: '重置按钮' },
                    { id: 'importSymbols', name: '导入按钮' },
                    { id: 'exportSymbols', name: '导出按钮' },
                    { id: 'englishOnly', name: '英文符号复选框' }
                ];

                elements.forEach(({ id, name }) => {
                    const element = doc.getElementById(id);
                    if (element) {
                        html += `<div class="success">✓ ${name} (${id}) 存在</div>`;
                    } else {
                        html += `<div class="error">✗ ${name} (${id}) 不存在</div>`;
                    }
                });

                // 检查按钮的type属性
                const btn = doc.getElementById('btnConfigSymbols');
                if (btn) {
                    const type = btn.getAttribute('type');
                    html += `<div>按钮type属性: ${type || '未设置'}</div>`;
                }

            } catch (err) {
                html += `<div class="error">无法加载index.html: ${err.message}</div>`;
            }

            domTest.innerHTML = html;
        }

        // 测试2: 事件监听器检查
        async function testEvents() {
            const eventTest = document.getElementById('event-test');
            let html = '<h3>事件监听器状态:</h3>';

            try {
                // 动态加载主页面
                const response = await fetch('/index.html');
                const text = await response.text();

                // 创建iframe来加载完整页面
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                iframe.contentDocument.write(text);
                iframe.contentDocument.close();

                // 等待iframe加载完成
                await new Promise(resolve => {
                    iframe.onload = resolve;
                    setTimeout(resolve, 1000); // 超时保护
                });

                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const btn = iframeDoc.getElementById('btnConfigSymbols');

                if (btn) {
                    // 检查是否有事件监听器
                    html += `<div class="success">✓ 按钮元素存在于页面中</div>`;

                    // 尝试获取事件监听器信息
                    if (typeof getEventListeners !== 'undefined') {
                        const listeners = getEventListeners(btn);
                        html += `<div>事件监听器: ${JSON.stringify(listeners)}</div>`;
                    } else {
                        html += `<div class="warning">⚠ 无法直接检查事件监听器（需要在Chrome DevTools中运行）</div>`;
                    }
                } else {
                    html += `<div class="error">✗ 按钮在iframe中未找到</div>`;
                }

                document.body.removeChild(iframe);

            } catch (err) {
                html += `<div class="error">测试失败: ${err.message}</div>`;
            }

            eventTest.innerHTML = html;
        }

        // 测试3: 模块加载检查
        async function testModules() {
            const moduleTest = document.getElementById('module-test');
            let html = '<h3>JavaScript模块加载状态:</h3>';

            try {
                // 尝试导入symbol-editor模块
                const module = await import('./modules/symbol-editor.js');
                html += `<div class="success">✓ symbol-editor.js 模块加载成功</div>`;

                if (module.initSymbolEditor) {
                    html += `<div class="success">✓ initSymbolEditor 函数存在</div>`;
                } else {
                    html += `<div class="error">✗ initSymbolEditor 函数不存在</div>`;
                }

                if (module.getSymbolConfig) {
                    html += `<div class="success">✓ getSymbolConfig 函数存在</div>`;
                } else {
                    html += `<div class="error">✗ getSymbolConfig 函数不存在</div>`;
                }

                if (module.isEnglishOnly) {
                    html += `<div class="success">✓ isEnglishOnly 函数存在</div>`;
                } else {
                    html += `<div class="error">✗ isEnglishOnly 函数不存在</div>`;
                }

                if (module.defaultSymbolConfig) {
                    html += `<div class="success">✓ defaultSymbolConfig 对象存在</div>`;
                    html += `<div>默认配置键数量: ${Object.keys(module.defaultSymbolConfig).length}</div>`;
                } else {
                    html += `<div class="error">✗ defaultSymbolConfig 对象不存在</div>`;
                }

            } catch (err) {
                html += `<div class="error">✗ 模块加载失败: ${err.message}</div>`;
                html += `<pre>${err.stack}</pre>`;
            }

            moduleTest.innerHTML = html;
        }

        // 测试4: 手动触发
        document.getElementById('manual-test').addEventListener('click', async () => {
            const resultDiv = document.getElementById('manual-result');

            try {
                // 直接在当前页面创建弹窗元素
                if (!document.getElementById('symbolModal')) {
                    const modalHTML = await fetch('/index.html').then(r => r.text());
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(modalHTML, 'text/html');
                    const modal = doc.getElementById('symbolModal');

                    if (modal) {
                        document.body.appendChild(modal);
                        resultDiv.innerHTML = '<div class="success">✓ 弹窗HTML已添加到页面</div>';
                    }
                }

                // 手动显示弹窗
                const modal = document.getElementById('symbolModal');
                if (modal) {
                    modal.style.display = 'block';
                    resultDiv.innerHTML += '<div class="success">✓ 弹窗已显示</div>';

                    // 添加关闭功能
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal || e.target.id === 'closeSymbolModal') {
                            modal.style.display = 'none';
                            resultDiv.innerHTML += '<div>弹窗已关闭</div>';
                        }
                    });
                } else {
                    resultDiv.innerHTML = '<div class="error">✗ 无法找到弹窗元素</div>';
                }

            } catch (err) {
                resultDiv.innerHTML = `<div class="error">✗ 手动触发失败: ${err.message}</div>`;
            }
        });

        // 运行所有测试
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('开始运行诊断测试...');
            await testDOM();
            await testEvents();
            await testModules();
            console.log('诊断测试完成');
        });

        // 捕获全局错误
        window.addEventListener('error', (e) => {
            console.error('全局错误:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('未处理的Promise拒绝:', e.reason);
        });
    </script>
</body>
</html>